#!/bin/bash
set -e

bundle install

if [ -f package.json ]; then
  CI=true pnpm install
  # Fix esbuild permissions (pnpm v10+ ignores build scripts by default)
  find node_modules -name esbuild -type f -exec chmod +x {} \; 2>/dev/null || true
fi

rm -f tmp/pids/server.pid

if [ -f bin/rails ]; then
  bin/rails db:prepare
fi

exec "$@"
